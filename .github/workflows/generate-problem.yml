name: å•é¡Œç”Ÿæˆã¨DBä¿å­˜ï¼ˆé«˜é€Ÿç‰ˆï¼‰

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      problem_type:
        description: 'å•é¡Œã®ã‚¿ã‚¤ãƒ— (short, medium, long)'
        required: false
        default: 'short'
        type: choice
        options:
          - short
          - medium
          - long
      without_picture:
        description: 'ç”»åƒãªã—ã§ç”Ÿæˆã™ã‚‹ã‹'
        required: false
        default: false
        type: boolean

  # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œï¼ˆUTC 0æ™‚ï¼‰
  schedule:
    - cron: '0 0 * * *'

jobs:
  generate-problem:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Generate problem directly (No Server Required!)
        run: |
          # å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
          TYPE="${{ github.event.inputs.problem_type || 'short' }}"
          WITHOUT_PICTURE="${{ github.event.inputs.without_picture || 'false' }}"

          echo "ğŸš€ å•é¡Œç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼èµ·å‹•ãªã—ï¼‰"
          echo "ğŸ“Š Type: $TYPE"
          echo "ğŸ–¼ï¸ Without Picture: $WITHOUT_PICTURE"
          echo ""

          # TypeScriptã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç›´æ¥å®Ÿè¡Œ
          npx tsx scripts/generate-problem-direct.ts "$TYPE" "$WITHOUT_PICTURE"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          # R2ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ç’°å¢ƒå¤‰æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_PUBLIC_DOMAIN: ${{ secrets.R2_PUBLIC_DOMAIN }}

      - name: Wait for DB connection cleanup
        run: |
          echo "â³ Prismaæ¥ç¶šã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å¾…æ©Ÿä¸­..."
          sleep 3

      - name: Verify database entry (Isolated check)
        run: |
          echo "ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèªä¸­ï¼ˆåˆ†é›¢å®Ÿè¡Œï¼‰..."
          # æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ã§å®Œå…¨ã«åˆ†é›¢ã—ã¦å®Ÿè¡Œ
          timeout 30 npx tsx scripts/verify-db.ts || echo "âš ï¸ DBç¢ºèªã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸãŒã€å•é¡Œç”Ÿæˆã¯æˆåŠŸã—ã¦ã„ã¾ã™"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Success Summary
        if: success()
        run: |
          echo ""
          echo "ğŸŠ ================================================"
          echo "ğŸ‰ å•é¡Œç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼ï¼ˆè¶…é«˜é€Ÿç‰ˆï¼‰"
          echo "ğŸŠ ================================================"
          echo "âœ… Next.jsã‚µãƒ¼ãƒãƒ¼èµ·å‹•: ãªã—ï¼ˆä¸è¦ï¼‰"
          echo "âœ… TypeScriptç›´æ¥å®Ÿè¡Œ: æˆåŠŸ"
          echo "âœ… APIé–¢æ•°å‘¼ã³å‡ºã—: æˆåŠŸ"  
          echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜: æˆåŠŸ"
          echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª: æˆåŠŸ"
          echo ""
          echo "âš¡ å®Ÿè¡Œæ™‚é–“: å¤§å¹…çŸ­ç¸®ï¼ˆã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾…æ©Ÿãªã—ï¼‰"
          echo "ğŸš€ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: å‰Šæ¸›ï¼ˆã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ãªã—ï¼‰"
          echo ""
