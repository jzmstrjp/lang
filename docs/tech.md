# 英語学習アプリ 要件定義（MVP～拡張見据え）

## 1. 目的・コンセプト

- 中高で構文は知っているが「聞き取れない」課題を解消する。
- **音声＋最小限の文脈（画像）**で意味を推測→4択で確定する体験を提供。
- **英語→日本語返答→英語再再生＋4択**の短サイクルで反復学習。
- ニュアンス（丁寧／カジュアル／乱暴）の違いを**場面画像と選択肢**で学べる。

## 2. 対象

- 日本語話者の英語初中級者。ログイン無しで即体験。

## 3. 学習設計の原則

- 文脈・画像で**9割理解**、残りを**耳で補完**する難易度帯。
- 文長は**短文／中文／長文**を固定しきい値（例：短1–4語／中5–9語／長10語+）。
- **ジャンルはランダム出題**（将来モード化可能）。UIでは長さのみ選択。

## 4. UXフロー（1問）

1. トップ：「英語学習を始める」／「短文」「中文」「長文」リンク
2. シーンA（画像1）：**英文音声**自動再生（字幕なし）
3. シーンB（画像2）：**日本語音声**再生（返答）
4. 4択画面：**英文音声を再度自動再生**→ユーザー回答
5. フィードバック：正誤表示＋（必要最小限の）正解表示
6. 「次の問題へ」→同カテゴリ内ランダム

※ 初回のオーディオ自動再生はブラウザ仕様により**ユーザーの初回タップ**でアンロックする。

## 5. 画面仕様（MVP）

- トップ：3リンク（/problems/short, /medium, /long）＋「はじめる」。
- シーン画面：画像全幅（16:9想定）、操作は「次へ」以外無し。
- 4択画面：日本語選択肢4つ。ページ表示0.5秒後に英文音声を自動再生。
- 正誤画面：結果、再生ボタン（英／日）、最低限の解説（任意）、次へ。
- 表示文言は**日本語UI**。英語字幕は出さない（MVP）。

## 6. 出題ルール

- URLで文長選択：`/problems/short|medium|long`。
- 同カテゴリ内から**ランダム1問**。
- **初回出題はキャッシュ済みプールからランダム**（体感待ち時間ゼロ）。
- 以降は「キャッシュ優先（十分量あり）／ときどき新規生成」で多様性確保。

## 7. 音声仕様

- 英語MP3と日本語MP3を**別ファイル**で保存・配信。
- フォーマット：MP3（44.1kHz/monoで可）、固定話者・固定速度（変化不要）。
- 4択画面表示時に**英文音声自動再生**。フィードバック画面に再生ボタン（英／日）。
- 生成：初回のみTTS→**R2に保存**→DBにURL格納→以降キャッシュ配信。

## 8. 画像仕様

- **英文が同じなら同一画像**（同一scene_idを参照）。
- **言い回しが違うなら画像も変える**（シーン・雰囲気が異なるため）。
- 1問につき最低1枚（シーンA）。必要に応じて返答シーンBは別画像も可。
- 生成は初回のみ→R2保存→以降キャッシュ配信。

## 9. データモデル（論理）

- Problem
  - id, type(`short|medium|long`), english, japanese_reply
  - options(JSON配列・文字列4件), correct_index(Int)
  - scene_id(String), scene_prompt(Text)
  - speakers_scene_a(String), speakers_scene_b(String)
  - word_count(Int), interaction_intent(`request|question|opinion|agreement|info`)
  - audio_en_url?, audio_ja_url?, scene_a_image_url?, scene_b_image_url?
  - nuance(`polite|casual|rude`等), genre(String), pattern_group(String)
  - is_cached(Bool), quality_check(Bool), created_at, updated_at
- ProblemAsset
  - id, problem_id(FK), scene_prompt(Text)
  - scene_a_image(Text), scene_b_image(Text)
  - audio_en(Text), audio_ja(Text)
  - created_at, updated_at
- （拡張）Dialogue
  - id, type, genre, turns(JSON: [{speaker, lang, text, audio_url}...])
  - quiz_target_index(Int) ※どのターンを問題化するか

※ MVPではProblemのみで可。将来ラリー導入時にDialogueを追加。

## 10. API仕様（MVP）

- `GET /api/problem?type=short|medium|long`
  - 処理：
    1. 当該typeの`is_cached && quality_check`から**ランダム**（初回は必ずここ）
    2. プールが閾値未満なら**新規生成→保存**して返却
    3. プールが十分なら**90%キャッシュ／10%新規生成**（可変可）
  - 返却：Problem 1件（前記フィールド）
- （管理）`POST /api/admin/generate` ※管理者のみ（本番では無効化可）
  - 指定type・件数の一括生成（CLI相当のHTTP版）

## 11. 生成・キャッシュ戦略

- **初回生成→永続キャッシュ**（R2＋URLをDB保存）。
- **カテゴリごと閾値30件**：
  - `<30`：必ず新規生成でプール育成
  - `>=30`：**キャッシュ90%／新規10%**（多様性維持）
- キャッシュキーは**テキスト＋話者ID＋速度＋モデル版**でハッシュ（将来の差分に備える）。
- 品質：自動フィルタで明らかな不自然文を弾き、`quality_check=true`のみ初回候補に。

## 12. インフラ・構成（方針）

- フロント／API：Next.js（App Router/Edge可）
- DB：PostgreSQL（Supabase/Neon）＋Prisma
- ストレージ：**Cloudflare R2＋Cloudflare CDN**（egress無料前提）
- ホスティング：Vercel（Pro想定）
- IaC：Terraform（dev/prod分離、Secretsはマネージドに保持）
- 音声：OpenAI TTS または ElevenLabs（MP3）
- 画像：DALL·E or SD系API
- 文章生成：OpenAI（自然さ重視）

## 13. 環境・運用

- 環境：dev（共有クラウドDB/R2）／prod。
- 初期ストック：**type別30問×3=90問**を一括生成（ローカルCLIで可）。
- ローカル開発：SQLiteでも可だが、**複数人開発はクラウドdev DB**推奨。
- デプロイ：Vercel。生成APIは基本**サーバ側のみ使用**（一般公開しない）。

## 14. 非機能要件

- レイテンシ：4択画面表示→英文再生開始まで**≤500ms**（キャッシュ前提）。
- 可用性：TTS/画像API障害時は**既存キャッシュのみで継続**。
- コスト：APIは初回のみ、配信は**R2+CDN**で最小化。
- 互換性：最新Chrome/Safari/Edge/Firefox、iOS/Android主要端末。
- アクセシビリティ：画像alt、ボタンのタップ領域48px、音量操作UI。

## 15. 失敗時挙動

- 音声取得失敗：英日とも再試行→失敗時は**次の問題**を提示。
- 画像取得失敗：プレースホルダー画像表示＋学習継続。
- 生成失敗：キャッシュから代替出題。
- 自動再生不可（ブラウザ制限）：最初のタップで「音声許可」ダイアログ→以降自動再生。

## 16. 計測（匿名）

- イベント：開始、英文再生、4択表示、回答、正誤、次へ。
- 指標：正答率、1問あたり時間、放棄率、音声再生失敗率。
- 保存：匿名セッションID（localStorage）。**個人特定情報は収集しない**。

## 17. 品質基準

- 自然さ：不自然・場違いな語彙は禁止。
- ニュアンス整合：`nuance`タグに合う画像・文体であること。
- 音量・無音：音頭は-16 LUFS目安、頭出し無音≤200ms。
- 選択肢：意味近接2案＋明確誤答2案。重複NG、長さバランス。

## 18. 将来拡張（設計で先に許容）

- **ラリーモード**：2–3ターン、問題化は1ターンのみ。Dialogueで管理。
- **ジャンルモード**：`genre`でフィルタ（business/dining/travel…）。
- **管理UI/CI**：CLI→GitHub Actions→管理API→管理コンソールの順で段階導入。
- **難易度制御**：低正答問題の出題頻度UP、SRSは将来検討。
- **多言語UI**：日本語→英語UI切替。

## 19. セキュリティ・法務

- 生成APIは**非公開**／管理者認証必須。Rate limit。
- SecretsはVercel/Cloudflare側で管理。リポジトリ直書き禁止。
- 画像・音声のライセンス／クローン音声の同意管理を明文化。
- プライバシー：ログイン無し、匿名計測のみ。ポリシー掲示。

## 20. コスト方針（概算）

- 生成API：初回90問＋漸増のみ＝**月 数千～1万円**目安。
- 配信：R2+CDNで**数十ドル**程度。
- Vercel Pro：$20/月。
- 合計：**1万～2万円/月**（大規模バズ時も配信コスト中心で伸びる）。

## 21. 受け入れ基準（MVP）

- `/problems/short|medium|long`で即学習開始できる。
- 1問フロー（英→日→英＋4択→結果→次へ）が**1クリック以内**で循環。
- 自動再生が全主要ブラウザで機能（初回タップで権限付与）。
- 各typeで**30問以上キャッシュ**、レスポンス≤500ms（4択画面の再生開始）。
- 不具合時のフォールバックが機能し学習が継続可能。

## 22. 運用TODO（仕様のみ）

- 初期90問を一括生成してR2＋DBに投入（品質軽査）。
- `quality_check=true`のみ初回ランダム対象に設定。
- メトリクス監視（正答率・失敗率）→不良問題を除外。
- コスト監視（R2容量/リクエスト）→必要に応じて画像圧縮最適化。
